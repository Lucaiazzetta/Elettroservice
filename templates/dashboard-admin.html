<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="stylesheet" href="styleadmin.css">
    <title>Admin Dashboard - ElettroService</title>
   
</head>
<body>

    <div class="sidebar">
        <a href="#" class="logo">ADMIN PANEL</a>
        <a href="#" class="menu-link active">Dashboard</a>
        <a href="#" class="menu-link">Richieste Preventivi</a>
        <a href="#" class="menu-link logout" onclick="window.location.href='/login.html'">Logout</a>
    </div>

    <div class="main-content">
        <header style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
            <div>
                <h2>Pannello Controllo</h2>
                <p style="color: #666;">Gestione globale preventivi MongoDB</p>
            </div>
        </header>

        <div class="cards-grid">
            <div class="card">
                <h4>Totale Richieste</h4>
                <div id="count-total" class="value" style="font-size: 2rem; font-weight: 700; color: #007bff;">0</div>
            </div>
        </div>

        <div class="table-container">
            <h3>Richieste da Gestire</h3>
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Servizio</th>
                        <th>Dettagli Guasto</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="admin-quotes-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:5000/api";

async function loadAllQuotes() {
    try {
        const response = await fetch(`${API_BASE}/get_quotes`, { 
            credentials: 'include' 
        });
        
        if (!response.ok) {
            window.location.href = 'login.html'; 
            return;
        }

        const quotes = await response.json();
        const tbody = document.getElementById('admin-quotes-body');
        
       
        tbody.innerHTML = quotes.map(q => `
            <tr>
                <td>${q.date}</td>
                <td><strong>${q.username}</strong></td>
                <td>${q.title}</td>
                <td>${q.description}</td>
                <td>
                    <button onclick="gestisci('${q._id}')" style="cursor:pointer; padding:5px 10px;"> Gestisci</button>
       
    
</td>
            </tr>
        `).join('');
    } catch (err) {
        console.error("Errore caricamento admin:", err);
    }
}


async function gestisci(id) {
    const nuovoStato = prompt("Inserisci il nuovo stato (es: Approvato, In Lavorazione, Rifiutato):");
    if (!nuovoStato) return;

    const prezzo = prompt("Inserisci il prezzo (es: 150):");

    try {
        const response = await fetch(`${API_BASE}/update_quote`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ 
                id: id, 
                status: nuovoStato,
                price: prezzo 
            })
        });

        const data = await response.json();
        if (data.success) {
            alert("✅ Preventivo aggiornato!");
            loadAdminQuotes(); 
        } else {
            alert("❌ Errore: " + data.message);
        }
    } catch (err) {
        alert("❌ Errore di connessione al server");
    }
}

window.onload = loadAllQuotes;
    </script>
</body>
</html>