<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"   href="styleuser.css">
    <title>Area Clienti - ElettroService</title>
    
</head>
<body>

   <nav class="navbar">
    <a href="#" class="logo">ElettroService</a>

    <div class="nav-links">
        <a href="Index.html" class="menu-link active">Home</a>
       <a href="#" class="menu-link" onclick="apriPopupPreventivi()">I miei Preventivi</a>
        <a href="#" class="menu-link logout" onclick="window.location.href='/login.html'">Esci</a>
    </div>
</nav>

<div class="main-content">
    </div>

    <div class="main-content">
        <header>
            
            <h2 id="welcome-msg">Richiedi un preventivo compilando il form di richiesta</h2>
            
        </header>

        <div class="form-container">
            
            <h3>Richiedi un nuovo Preventivo</h3>
            <p style="font-size: 0.9rem; color: #777; margin-bottom: 15px;">Descrivi il problema del tuo dispositivo.</p>
            <form id="quote-form">
                <div class="form-group">
                    <label>Modello Dispositivo / Servizio</label>
                    <input type="text" id="title" placeholder="Es: iPhone 14 Pro - Cambio Schermo" required>
                </div>
                <div class="form-group">
                    <label>Descrizione Dettagliata</label>
                    <textarea id="description" rows="3" placeholder="Descrivi il guasto..." required></textarea>
                </div>
                <button type="submit" class="btn-submit">Invia Richiesta</button>
            </form>
        </div>

        <div id="modalPreventivi" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="chiudiPopupPreventivi()">&times;</span>
        <h3>I tuoi Preventivi </h3>
        
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Servizio</th>
                    <th>Descrizione</th>
                    <th>Stato</th>
                    <th>Prezzo</th>
                </tr>
            </thead>
            <tbody id="quotes-body-popup">
                </tbody>
        </table>
    </div>
</div>

        <div class="lista-preventivi">
            <h3>I tuoi Preventivi recenti</h3>
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Servizio</th>
                        <th>Descrizione</th>
                        <th>Stato</th>
                    </tr>
                </thead>
                <tbody id="quotes-body-page">
                    </tbody>
            </table>
        </div>
    </div>

    <script>

        async function checkSession() {
    const res = await fetch(`${API_BASE}/get_quotes`, {
        credentials: 'include'
    });
    if (res.status === 401) {
        window.location.href = "/login.html";
    }
}

window.onload = () => {
    checkSession();
    loadQuotes();
};

 
 const API_BASE = "http://127.0.0.1:5000/api";


async function loadQuotes() {
    // 1. Selezioniamo entrambi i contenitori (Pagina e Popup)
    const tbodyPage = document.getElementById('quotes-body-page');
    const tbodyPopup = document.getElementById('quotes-body-popup');
    
    // Messaggio di caricamento per entrambi (se esistono nella pagina)
    if(tbodyPage) tbodyPage.innerHTML = "<tr><td colspan='5'>Caricamento...</td></tr>";
    if(tbodyPopup) tbodyPopup.innerHTML = "<tr><td colspan='5'>Caricamento...</td></tr>";

    try {
        const response = await fetch(`${API_BASE}/get_quotes`, { 
            credentials: 'include' 
        });

        if (!response.ok) throw new Error("Errore sessione");

        const quotes = await response.json();
        
        // Funzione helper per creare le righe HTML (così non ripetiamo codice)
        const generateRows = (data) => {
            if (data.length === 0) return "<tr><td colspan='5' style='text-align:center'>Nessun preventivo.</td></tr>";
            
            return data.map(q => {
                let statusClass = "badge-waiting";
                if (q.status === 'Approvato') statusClass = "badge-approved";
                if (q.status === 'Rifiutato') statusClass = "badge-rejected";

                return `
                    <tr>
                        <td>${q.date}</td>
                        <td><strong>${q.title}</strong></td>
                        <td>${q.description}</td>
                        <td><span class="badge ${statusClass}">${q.status || 'In Attesa'}</span></td>
                        <td>${q.price ? '€ ' + q.price : '---'}</td>
                    </tr>
                `;
            }).join('');
        };

        const htmlRows = generateRows(quotes);

        // 2. Inseriamo le righe in ENTRAMBE le tabelle
        if(tbodyPage) tbodyPage.innerHTML = htmlRows;
        if(tbodyPopup) tbodyPopup.innerHTML = htmlRows;

    } catch (err) {
        console.error("Errore nel caricamento:", err);
    }
}

document.getElementById('quote-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value
    };
    
    const response = await fetch(`${API_BASE}/submit_quote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', // <--- QUESTA RIGA È VITALE
        body: JSON.stringify(payload)
    });

    const data = await response.json();
    if(data.success) {
        alert("Inviato!");
        loadQuotes();
    } else {
        alert("Errore: " + data.message);
    }
});
// Apre il popup e ricarica i dati dal server Python
function apriPopupPreventivi() {
    document.getElementById("modalPreventivi").style.display = "block";
    loadQuotes(); // Chiama la tua funzione esistente che fa il fetch
}

// Chiude il popup
function chiudiPopupPreventivi() {
    document.getElementById("modalPreventivi").style.display = "none";
}

// Chiude se clicchi fuori dal box bianco
window.onclick = function(event) {
    var modal = document.getElementById("modalPreventivi");
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
async function loadUserData() {
    try {
       
        
       
        const nomeUtente = localStorage.getItem("username"); 
       
      
if (nomeUtente) {

            
            const headerGreeting = document.getElementById("user-greeting-header");
            if(headerGreeting) headerGreeting.innerText = `Ciao, ${nomeUtente}`;
        }
    } catch (err) {
        console.error("Impossibile caricare il nome utente", err);
    }
}
        



window.onload = () => {
    checkSession();
    loadQuotes();
    loadUserData();
    };
    </script>
</body>
</html>